# -*- coding: utf-8 -*-
import pickle
from collections import defaultdict
from dtw import dtw
from numpy.linalg import norm

sample_interval= 0.01
window_len = 0.025
n_mfcc = 12
sample_delay =14
sample_len = 28

emo_list = ['angry', 'contempt', 'disgusted', 'fear', 'happy', 'neutral', 'sad', 'surprised']
level_list = ['1', '2', '3']
actor = 'M003'
sentence_M003 = [
                ['001','001','028','001','001','001','001','001'], # Sentence A
                ['002','002','029','002','002','002','002','002'], # Sentence B
                ['021','020','018','021','021','031','021','021'], # ...
                ['022','021','019','022','022','032','022','022'],
                ['023','022','020','023','023','033','023','023'],
                ['024','023','021','024','024','034','024','024'],
                ['025','024','022','025','025','035','025','025'],
                ['026','025','023','026','026','036','026','026'],
                ['027','026','024','027','027','037','027','027'],
                ['028','027','025','028','028','038','028','028'],
                ['029','028','026','029','029','039','029','029'],
                ['030','029','027','030','030','040','030','030'],
                ['003','003','030','003','003','003','003','003']
            ]
num_sentence = len(sentence_M003) # 13

voca_lip_list = [1572, 1573, 1576, 1577, 1578, 1579, 1580, 1581, 1582, 1583, 1588, 1589, 1590, 1591, 1592, 1593, 1594, 1595, 1657, 1658, 1659, 1660, 1661, 1662, 1663, 1664, 1665, 1666, 1667, 1668, 1669, 1670, 1691, 1693, 1694, 1695, 1696, 1697, 1700, 1702, 1703, 1704, 1709, 1710, 1711, 1712, 1713, 1714, 1715, 1716, 1717, 1718, 1719, 1720, 1721, 1722, 1723, 1724, 1725, 1728, 1729, 1730, 1731, 1732, 1733, 1734, 1735, 1736, 1737, 1738, 1739, 1740, 1741, 1742, 1743, 1744, 1745, 1746, 1747, 1748, 1749, 1750, 1751, 1758, 1763, 1764, 1765, 1770, 1771, 1773, 1774, 1775, 1776, 1777, 1778, 1779, 1780, 1781, 1782, 1787, 1788, 1789, 1791, 1792, 1793, 1794, 1795, 1796, 1801, 1802, 1803, 1804, 1826, 1827, 1830, 1831, 1832, 1835, 1836, 1846, 1847, 1848, 1849, 1850, 1851, 1852, 1854, 1860, 1861, 1862, 1865, 1866, 2708, 2709, 2712, 2713, 2714, 2715, 2716, 2717, 2718, 2719, 2724, 2725, 2726, 2727, 2728, 2729, 2730, 2731, 2774, 2775, 2776, 2777, 2778, 2779, 2780, 2781, 2782, 2783, 2784, 2785, 2786, 2787, 2808, 2810, 2811, 2812, 2813, 2814, 2817, 2819, 2820, 2821, 2826, 2827, 2828, 2829, 2830, 2831, 2832, 2833, 2834, 2835, 2836, 2837, 2838, 2839, 2840, 2841, 2842, 2843, 2844, 2845, 2846, 2847, 2848, 2849, 2850, 2851, 2852, 2853, 2854, 2855, 2856, 2857, 2858, 2859, 2860, 2861, 2862, 2863, 2864, 2865, 2866, 2869, 2871, 2872, 2873, 2878, 2879, 2880, 2881, 2882, 2883, 2884, 2885, 2886, 2887, 2888, 2889, 2890, 2891, 2892, 2894, 2895, 2896, 2897, 2898, 2899, 2904, 2905, 2906, 2907, 2928, 2929, 2930, 2931, 2932, 2933, 2934, 2935, 2936, 2937, 2938, 2939, 2940, 2941, 2942, 2943, 2944, 2945, 2948, 2949, 3497, 3500, 3503, 3504, 3506, 3509, 3511, 3512, 3513, 3514, 3531, 3533, 3541, 3543, 3546, 3547, 3549, 3790, 3791, 3792, 3793, 3794, 3795, 3796, 3797, 3798, 3799, 3800, 3805, 3806, 3914, 3915, 3916, 3917, 3918, 3919, 3920, 3921, 3922, 3923, 3927, 3928]
lip_idx = []
for idx in voca_lip_list:
    lip_idx.append(idx*3)
    lip_idx.append(idx*3+1)
    lip_idx.append(idx*3+2)

save_dir = '../../data/feature/dataset_m003_vtx_dtw.pickle'
vtx_dir = '../../data/feature/dataset_m003_vtx.pickle'
f = open(vtx_dir, 'rb')
vtx = pickle.load(f)
f.close()

vtx_dtw_dict = defaultdict(dict)
for i in range(num_sentence):
    emo_file_list = sentence_M003[i]

    for j in range(len(emo_list)):
        for level in level_list:
            filename = f"{actor}_front_{emo_list[j]}_{level}_{emo_file_list[j]}"

            if (j == 0) and (int(level) == 3): # basis. no dtw
                vtx_dtw_dict[f"{i}"][f"{emo_list[j]}_{level}_{filename}"] = vtx[filename]
                basis_vtx = vtx[filename]
            else:
                try:
                    new_vtx = vtx[filename]
                except:
                    print(f"[ERROR] Sentence: {j}, emotion: {emo_list[j]}, level: {level}, filename: {filename} - No such file!")
                    continue

                dist, cost, acc_cost, path = dtw(new_vtx[:, lip_idx], basis_vtx[:, lip_idx], dist=lambda x, y: norm(x - y, ord=1)) # (dist: 입 중심으로 align해야하니까 입 버텍스 피쳐만??)
                dtw_vtx = basis_vtx.copy()

                a = path[0]
                b = path[1]
                for l in range(1, len(path[0])):
                    dtw_vtx[b[l]] = new_vtx[a[l]]

                vtx_dtw_dict[f"{i}"][f"{emo_list[j]}_{level}_{filename}"] = dtw_vtx

            if emo_list[j] == "neutral":
                break

        print(i, emo_list[j])

with open(save_dir, 'wb') as f:
    pickle.dump(vtx_dtw_dict, f)
